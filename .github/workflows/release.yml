name: Release Mod

on:
  push:
    tags:
      - 'v*'

jobs:
  build-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Get version from tag
      id: get_version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Setup Geode SDK
      uses: geode-sdk/setup-geode@v1
      with:
        version: nightly

    - name: Build for all platforms
      run: |
        # Build for Windows
        cmake -B build-win -DCMAKE_BUILD_TYPE=Release -DGEODE_PLATFORM=win
        cmake --build build-win --config Release
        
        # Build for macOS
        cmake -B build-mac -DCMAKE_BUILD_TYPE=Release -DGEODE_PLATFORM=mac
        cmake --build build-mac --config Release
        
        # Build for Android
        cmake -B build-android -DCMAKE_BUILD_TYPE=Release -DGEODE_PLATFORM=android
        cmake --build build-android --config Release

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        name: Release v${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          bin/*.geode
          bin/*.log

  publish-geode:
    needs: build-release
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Publish to Geode Index
      run: |
        # This would publish to the Geode mod index
        # You'll need to set up authentication
        echo "Publishing to Geode index..."
        # curl -X POST https://api.geodesdk.dev/mod/publish \
        #   -H "Authorization: Bearer ${{ secrets.GEODE_API_KEY }}" \
        #   -F "mod=@bin/your-mod.geode"
